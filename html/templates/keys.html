<h2>Cryptographic Keys</h2>

<p>
  TPM generates <b>strong</b>, <b>secure</b> cryptographic keys. Strong in the
  sense that the key is derived from true random source and large key space. In
  case of 3DES, TPM also checks that keys are not known weak keys. Secure in the
  sense that the private key material never leaves the TPM secure boundary in plain
  form. When a key leaves the TPM - in order to be loaded and used later - it is
  <b>wrapped</b> (<b>encrypted</b>) by its parent key.
  <br> Keys, therefore, form a <b>tree</b>: each key is wrapped by its parent,
  all the way to the root of the tree, where the <b>primary key</b> is derived
  from a fixed <b>seed</b>. The seed is stored in the TPM's NVDATA, under a reserved
  index, and cannot be read externally.
</p>

<p>
  <img src="images/key_tree.svg" class="img-responsive center-block" style="max-width:70%"
    alt="Key Tree">
</p>

<h3>Key Hierarchies</h3>
<p>
  The TPM stores keys on one of four hierarchies:
  <ol>
    <li>Endorsement hierarchy.</li>
    <li>Platform hierarchy.</li>
    <li>Owner hierarchy, also known as storage hierarchy.</li>
    <li>Null hierarchy.</li>
  </ol>
  A hierarchy is a logical collection of entities: keys and nv data blobs. Each hierarchy
  has a <b>different seed</b> and <b>different authorization policy</b>. Hierarchies differ
  by when their seeds are created and by who certifies their primary keys.
  <br> Generally speaking, the endorsement hierarchy is reserved for objects created
  and certified by the TPM manufacturer. The endorsement seed (eseed) is randomly
  generated at manufacturing time and never changes during the lifetime of the
  device. The primary endorsement key is certified by the TPM manufacturer, and
  because its seed never changes, it can be used to identify the device. Since
  there's only one TPM device per machine, the primary endorsement key can also
  be used as the machine's identity.
  <br> The platform hierarchy is reserved for objects created and certified by
  the OEM that builds the host platform. The platform seed (pseed) is randomly
  generated at manufacturing time, but can be changed by the OEM by calling <code>TPM2_CC_ChangePPS</code>.
  <br> The owner hierarchy is reserved for us - the primary users of the TPM. When
  a user takes ownership, for example, when the IT department provisions a new
  host on the network, the owner hierarchy is reset. This is done by calling
  <code>TPM2_CC_Clear</code>. In this critical setup step, two user keys should
  be provisioned and certified by the owner: these form the root of trust for all
  the keys generated on the owner hierarchy.
  <br> The null hierarchy is reserved for ephemeral keys. The null seed is re-generated
  each time the host reboots.
</p>

<h3>Primary Keys</h3>
<p>
  As mentioned, primary keys are derived from the primary seeds using a deterministic
  key derivation function (KDF). More accurately, the KDF takes as input the fixed
  seed and the key's template that describes its properties.
</p>

<p>
  <img src="images/kdf.svg" class="img-responsive center-block" style="max-width:70%"
    alt="KDF">
  <br>
  <div class="alert alert-info" role="alert">If either the seed or the template changes, a completely different primary key
    is created</div>
</p>

<p>
  The template is defined in the <code>TPM2B_PUBLIC</code> structure. Important
  fields include the <i>type</i> that describes whether this is a symmetric or
  asymmetric key, the <i>objectAttributes</i> that describes whether the key is
  used for encryption or signing, the <i>parameters</i> that describes the key
  size and <i>unique</i> that is used as an entropy value.
  <br>
  <div class="alert alert-info" role="alert">By changing the entropy field, 
    the TPM can generate an unlimited number of primary
    keys of a given type (say RSA-2048).</div>
</p>

<p>
  A primary key is created with the <code>TPM2_CC_CreatePrimary</code> command.
</p>

<h3>Object Attributes</h3>

<p>
  Object attributes bitmap field is part of <code>TPM2B_PUBLIC</code>. For our
  experiments it's important to understand the following attributes:
  <ul>
    <li>Decrypt (<i>TPMA_OBJECT_DECRYPT</i>). Specifies an encryption key.</li>
    <li>Sign (<i>TPMA_OBJECT_SIGN_ENCRYPT</i>). Specifies a signing key.</li>
    <li>Restricted (<i>TPMA_OBJECT_RESTRICTED</i>). Restricts the key to signing/encrypting
      only internal TPM data.</li>
  </ul>

  A hierarchy can be thought of as having parent and child keys. Parent keys protect
  its children, offering secrecy and integrity when the child key is stored outside
  the TPM. Keys that wrap other keys are also called <em>storage keys</em>. Storage
  keys are restricted encryption keys. They cannot be used for general decryption,
  which could then leak the child's secrets.

  <br> The ultimate parent at the top of the hierarchy is a primary key. Children
  can be storage keys, in which case they can also be parents. Children can also
  be non-storage keys, in which case they're leaf keys: children but never parents.

</p>

<h3>Child Keys</h3>

<p>
  Information about child keys
</p>

<h3>Persistent Keys</h3>

<p>
  Information on what persistent keys are for
</p>

