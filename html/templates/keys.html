<h2>Cryptographic Keys</h2>

<p>
  TPM can generate <b>strong, secure</b> cryptographic keys. <b>Strong</b> in the sense that the key is derived from a true random source and a large key space. 
  <b>Secure</b> in the sense that the private key material never leaves the TPM secure boundaries in plain form. Since TPM is a very small device, we can not store the keys directly onto it. 
  Therefore, every key generated by a TPM is encrypted by its parent key, forming a <b>tree</b> with a root at a special key known as the <b>primary key</b>. 
  The primary key is derived from two sources: the seed for the hierarchy (more about hierarchys in the next section) and the template.
</p>

<p>
  <img src="images/key_tree.svg" class="img-responsive center-block" style="max-width:70%"
    alt="Key Tree">
</p>

<h3>Key Hierarchies</h3>
<p>
  The TPM stores keys on one of four hierarchies:
  <ol>
    <li>Endorsement hierarchy.</li>
    <li>Platform hierarchy.</li>
    <li>Owner hierarchy, also known as storage hierarchy.</li>
    <li>Null hierarchy.</li>
  </ol>
  A hierarchy is a logical collection of entities: keys and nv data blobs. Each hierarchy
  has a <b>different seed</b> and <b>different authorization policy</b>. Hierarchies differ
  by when their seeds are created and by who certifies their primary keys.
  <br> Generally speaking, the endorsement hierarchy is reserved for objects created
  and certified by the TPM manufacturer. The endorsement seed (eseed) is randomly
  generated at manufacturing time and never changes during the lifetime of the
  device. The primary endorsement key is certified by the TPM manufacturer, and
  because its seed never changes, it can be used to identify the device. Since
  there's only one TPM device per machine, the primary endorsement key can also
  be used as the machine's identity.
  <br> The platform hierarchy is reserved for objects created and certified by
  the OEM that builds the host platform. The platform seed (pseed) is randomly
  generated at manufacturing time, but can be changed by the OEM by calling <code>TPM2_CC_ChangePPS</code>.
  <br> The owner hierarchy is reserved for us - the primary users of the TPM. When
  a user takes ownership, for example, when the IT department provisions a new
  host on the network, the owner hierarchy is reset. In this critical setup step, two user keys should
  be provisioned and certified by the owner: these form the root of trust for all
  the keys generated on the owner hierarchy.
  <br> The null hierarchy is reserved for ephemeral keys. The null seed is re-generated
  each time the host reboots.
</p>

<h3>Primary Keys</h3>
<p>
  As mentioned, primary keys are derived from the primary seeds using a deterministic
  key derivation function (KDF). More accurately, the KDF takes as input the fixed
  seed and the key's template that describes its properties.
</p>

<p>
  <img src="images/kdf.svg" class="img-responsive center-block" style="max-width:70%"
    alt="KDF">
  <br>
  <div class="alert alert-info" role="alert">If either the seed or the template changes, a completely different primary key
    is created</div>
</p>

<p>
  Important fields of the template include the <i>type</i> that describes whether this is a symmetric or
  asymmetric key, the <i>objectAttributes</i> that describes whether the key is
  used for encryption or signing, the <i>parameters</i> that describes the key
  size and <i>unique</i> that is used as an entropy value.
  <br>
  <div class="alert alert-info" role="alert">By changing the entropy field, 
    the TPM can generate an unlimited number of primary
    keys of a given type (say RSA-2048).</div>
</p>

<h3>Child Keys</h3>

<p>
  A hierarchy can be thought of as having parent and child keys. Parent keys protect
  its children, offering secrecy and integrity when the child key is stored outside
  the TPM. Keys that wrap other keys are also called <em>storage keys</em>. Storage
  keys are restricted encryption keys. They cannot be used for general decryption,
  which could then leak the child's secrets.

  <br> The ultimate parent at the top of the hierarchy is a primary key. Children
  can be storage keys, in which case they can also be parents. Children can also
  be non-storage keys, in which case they're leaf keys: children but never parents.
</p>
