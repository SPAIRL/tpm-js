<h2>Sealing Data and Keys</h2>

Sealing is a scheme for protecting secrets, whether that be the data itself or, 
more commonly, the cryptographic keys generated by the TPM. In order to seal data, 
we need to create a session authorization.

<h3>Session Authorization</h3>
<p>
  In TPM, sealing refers to the process of encrypting sensitive data, such as passwords or keys, and tying it to the current state of the system. This means that the sealed data can only be decrypted and accessed if certain conditions are met, such as the system being in a particular state or the correct authorization token being presented.
</p>

<h4>Trial Session</h4>
<p>
  To create a seal, a trial session is first generated. This session is used to compute a digest, which is a small, fixed value of data derived from a set of user-defined PCR values. The PCR values represent the state of the system, such as the firmware version or the state of the boot loader. The digest is stored in the trial session object and serves as the authorization policy that must be met in order to access the sealed data.</p>
<p>
Calculating the authPolicy digest using a trial session is summarized in the following diagram:
</p>

<p>
  <img src="images/trial_session.svg" class="img-responsive center-block" style="max-width:90%"
    alt="Trial Session">
</p>
<p>
  <div class="alert alert-info" role="alert">A trial session doesn't include any secrets, it's, therefore, possible
    to compute the expected authPolicy digest offline, without a TPM. </div>
</p>

<h4>Policy Session</h4>
<p>
  Once the trial session has been created and the digest computed, we move on to the policy session. The policy session is used to read the current state of the PCR values and compute a digest. If the PCR values match the expected values from the trial session, then the digest computed in the policy session will match the digest in the trial session, indicating that the system is in the expected state.
  If the digests match, then the policy session can be used to access the sealed data. If the digests do not match, then access to the sealed data is denied. This ensures that the sensitive data can only be accessed when the system is in the expected state, providing a high level of security.
  In summary, sealing involves tying sensitive data to the current state of the system using a trial session and an authorization policy based on a digest. The policy session is then used to determine if the system is in the expected state and grant access to the sealed data if the conditions are met.
</p>

<p>
Policy session with good (expected) PCR values:
</p>

<p>
  <img src="images/policy_session_good.svg" class="img-responsive center-block" style="max-width:90%"
    alt="Trial Session">
</p>

<p>
Policy session with bad (unexpected) PCR values:
</p>
<p>
  <img src="images/policy_session_bad.svg" class="img-responsive center-block" style="max-width:90%"
    alt="Trial Session">
</p>